---
categories:
- jsdeobfuscator
- mozilla
date: "2015-07-17 23:00:17"
description: ""
slug: javascript-deobfuscator-reloaded
title: JavaScript Deobfuscator reloaded
---

<p>A few weeks ago I released <a href="https://addons.mozilla.org/addon/javascript-deobfuscator/">JavaScript Deobfuscator 2.0</a> &mdash; finally something that works with current Firefox versions again. Why did it take me a year to fix this compatibility issue? Well, it really wasn&#8217;t that simple. After considering all the possibilities I decided that rewriting it from scratch was the only possibility, and that was hard to accomplish in my spare time.</p>

	<p>Before I continue with the technical details, allow me to introduce JavaScript Deobfuscator in its new reincarnation: it now adds a panel to Firefox Developer Tools. Instead of messing with filters your view is limited to the current tab automatically. Both compiled and executed scripts go into the same list, with some text indicating whether we&#8217;ve seen the script being compiled or executed or both. Starting with Firefox 39 even code running in Web Workers will be displayed. And JavaScript Deobfuscator will beautify the code instead of relying on the JavaScript engine to do so.</p>

	<p>{{< img "jsdeobfuscator.png" "JavaScript Deobfuscator screenshot" >}}</p>

	<p>The downside is that only Firefox is supported now&nbsp;&mdash; other applications simply don&#8217;t have Developer Tools to integrate with. Also, debugging add-ons or the browser itself isn&#8217;t possible&mdash;&mdash; Developer Tools run in a separate process for that, no add-ons installed there. Finally, the search functionality is absolutely rudimentary right now, that&#8217;s something I hope to improve eventually.</p>

	<p>Now to the technical details. The reason for this overhaul is the <a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger-API">new debugging interface</a> which replaced the one JavaScript Deobfuscator was using. The old debugging interface was conceptually different, it was designed as a single hook to collect all data. The new one on the other hand collects data about individual compartments and it&#8217;s up to you to figure out which ones you need. After a few unsuccessful attempts to continue collecting all data in JavaScript Deobfuscator I realized that it made a lot more sense to look at individual tabs.</p>

	<p>Using the new debugging <span class="caps">API</span> turned out to be tricky to say the least. Did I link to <span class="caps">MDN</span> above? Sorry about that, I should have linked to the <a href="http://mxr.mozilla.org/mozilla-central/source/js/src/doc/Debugger/">SpiderMonkey source code</a>. It&#8217;s very similar to the <span class="caps">MDN</span> documentation but the later is outdated. And even if you look at the SpiderMonkey source, much of the documentation is merely wishful thinking, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=904716">listing features that were never implemented</a>.</p>

	<p>A new UI concept had to be developed as well, and the only good option for per-tab debugging would be integrating into the Firefox Developer Tools. That&#8217;s where the fun really started. I tried to make sense of the <a href="https://developer.mozilla.org/en-US/docs/Tools/DevToolsAPI">documentation</a>, studied the source code, figured out that <code>ToolDefinition.build()</code> is supposed to return a promise. Then I looked at what <code>TargetType</code> is and how existing tools work with it&nbsp;&mdash; this was the point where I realized that there are so many implementation details involved that an extension cannot possibly do it. So I gave up.</p>

	<p>When I came back a few months later things improved, slightly. Somebody wrote an <a href="https://developer.mozilla.org/en-US/docs/Tools/Adding_a_panel_to_the_toolbox">Add-on <span class="caps">SDK</span> module to create new Developer Tools panels</a>. While I didn&#8217;t use that module directly, it showed nicely which parts of the <span class="caps">API</span> are contractual and which ones are merely implementation details. It also showed that things aren&#8217;t too bad if you limit yourself to a single target type&nbsp;&mdash; a local tab. Handling remote connections to browser and add-ons is more complicated, but as I mentioned above extensions cannot do that anyway.</p>

	<p>Now that article stops at the point where you &#8220;merely&#8221; need to use the <a href="https://wiki.mozilla.org/Remote_Debugging_Protocol">remote debugging protocol</a> to communicate with the built-in debugging actor. Well, maybe it is really simple but I couldn&#8217;t figure out how to do this&nbsp;&mdash; and whether that protocol is something I can rely on. See, the built-in tools will certainly be adjusted when the debugging actor or/and the protocol change. My extension on the other hand will be broken, and I&#8217;ll need to invest time into figuring out what changed and how my code needs to be adjusted while staying compatible with older Firefox versions.</p>

	<p>So JavaScript Deobfuscator uses the debugging interface directly, without relying on the debugging actor of the Developer Tools. And it beautifies JavaScript code using its own copy of a library rather than relying on code used by Developer Tools&nbsp;&mdash; JavaScript beautification in Developer Tools is currently an implementation detail that extensions cannot rely on. JavaScript Deobfuscator also duplicates the styles of the two Developer Tools themes to make sure it looks similar to the existing panels&nbsp;&mdash; just using the styles from Developer Tools would have likely caused a disaster after only a few Firefox releases. Not that the built-in styles are really defined in a generic way, there is really lots of inconsistencies there and each panel is styled somewhat differently.</p>

	<p>These are only some examples, there is more code duplication. Developer Tools aren&#8217;t currently built to allow extensions to reuse their code. Still, I&#8217;m fairly happy with the result, and I hope that the largest chunk (JavaScript beautification) will go away eventually. From the usability point of view the new version is a huge leap forward, getting there could have been easier however.</p>