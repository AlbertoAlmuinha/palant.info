{
  "title": "Why you should make your next add-on restartless",
  "date": "2012-07-12 12:18:08",
  "description": "",
  "categories": [
    "adblock-plus",
    "gecko"
  ],
  "slug": "why-you-should-make-your-next-add-on-restartless"
}

	<p><strong>Note</strong>: This article is not about extensions based on the Add-on <span class="caps">SDK</span> (Jetpack). You don&#8217;t have to use the <span class="caps">SDK</span> to create a restartless extension. Just wanted to point this out explicitly to avoid confusion.</p>

	<p>An extension that will install without requiring a Firefox restart? This was a <a href="https://adblockplus.org/blog/how-many-hacks-does-it-take-to-make-your-extension-install-without-a-restart">nightmare to develop</a> not too long ago. Fortunately, things changed and the last showstopper bug was fixed in Firefox 8. Effort to create a restartless (or <a href="https://developer.mozilla.org/en/Extensions/Bootstrapped_extensions">bootstrapped</a> as it is called officially) extension is acceptable now. In fact, I have converted all my extensions and removed support for classic non-restartless extensions from my build tools&nbsp;&mdash; I am certain that I am not going back.</p>

	<p>So, how did it go? It was a mixed experience actually. The new extension type has significant advantages:</p>

	<ul>
		<li>The user experience is simply better. It is nice to install an extension within a second and to continue doing whatever you&#8217;ve been doing before&nbsp;&mdash; no restarting the browser, no session restore. And it also helps a lot if the user experiences issues: disable the extension, check whether the issue is gone. Takes only a few seconds.</li>
		<li>Testing a restartless extension during development is easier. Do you still use complicated test environments so that you can test changes without restarting the browser? Do you keep in mind which parts of your extension can be updated this way and which ones still require a browser restart? I simply use <a href="https://addons.mozilla.org/addon/autoinstaller/">Extension Auto-Installer</a> to update the extension in the browser instead&nbsp;&mdash; it&#8217;s fast and I actually test the same build that my users will get later.</li>
		<li>A simple extension is simple. Classic extensions require you to create numerous files and a directory structure. A restartless extension doesn&#8217;t need more than the install manifest (<code>install.rdf</code>) and a single JavaScript file (<code>bootstrap.js</code>) in the same directory.</li>
		<li>You have a centralized and logical place to run your code. The <code>bootstrap.js</code> file gives you a single environment that will be around for as long as your extension is enabled. Compare that to classic extensions where most extensions use overlays as a trick to inject scripts into the browser window. And then they struggle attempting to synchronize the code instances in different windows, e.g. by abusing preferences for something that doesn&#8217;t need to be persistent.</li>
		<li>You actually own the environment where <code>bootstrap.js</code> code runs. You don&#8217;t have to worry that another extension will declare a variable with the same name&nbsp;&mdash; you are not in a shared environment, only your own code executes here.</li>
		<li>If your extension leaks memory or doesn&#8217;t clean up after itself properly you will notice&nbsp;&mdash; because even after disabling the extension and minimizing memory use <code>about:memory?verbose</code> will still display a compartment belonging to your extension (thanks to Chris Finke for reminding me, I originally forgot listing this point). Investigating the memory leak will still be tedious but at least you will know it is there.</li>
	</ul>

	<p>There are disadvantages as well however:</p>

	<ul>
		<li>Converting an existing extension can be rather complicated, especially when it comes to user interface integration. In particular, making Adblock Plus restartless turned out way more time-consuming than I expected. This is of course easier if an extension is restartless from the very start.</li>
		<li>The platform mechanisms used for restartless extensions aren&#8217;t quite as well-tested as for the classic extensions. I didn&#8217;t notice it when I published my first eight restartless extensions, but Adblock Plus with its millions of users is a bug magnet of course. So I very soon discovered <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=770669">bug 770669</a>, rediscovered <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=744833">bug 744833</a>, and there seems to be yet another similar issue that I didn&#8217;t manage to reproduce yet.</li>
		<li>Many tools and helpers that the Gecko platform provides you with weren&#8217;t built with extensions in mind that can come and go at any time. So in many cases you will have to take a more complicated route and do things manually that should normally be handled by the platform.</li>
		<li>You <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=719180">cannot use <span class="caps">XBL</span></a>. And you <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=719376">have to append a random parameter to the <span class="caps">URL</span></a> when loading string bundles. Such annoyances will hopefully get less as the platform is improved.</li>
		<li>The documentation is unfortunately not very helpful. <span class="caps">MDN</span> has lots of examples and tutorials but those tend to ignore features that are less than five years old. You will get several detailed tutorials on creating classic extensions or using overlays but not a single one will mention even the existence of restartless extensions or the Add-on <span class="caps">SDK</span>. You have great code snippets for common tasks but these never use new and highly recommendable helpers like <a href="https://developer.mozilla.org/en/JavaScript_code_modules/Services.jsm">Services</a>, <a href="https://developer.mozilla.org/en/JavaScript_code_modules/FileUtils.jsm">FileUtils</a> or <a href="https://developer.mozilla.org/en/JavaScript_code_modules/NetUtil.jsm">NetUtil</a>. Even the <span class="caps">XPCOM</span> examples were occasionally ignoring <a href="https://developer.mozilla.org/en/JavaScript_code_modules/XPCOMUtils.jsm"><span class="caps">XPCOMU</span>tils</a> or using an approach that stopped working when Firefox 4 came out (I think that I got the important ones fixed however).</li>
	</ul>

	<p>For me, the advantages clearly outweigh the disadvantages. If you already have a classic extension then you may wait with converting it until you actually have time for that. But if you are planning a new extension then you certainly should make it restartless. I consider the complete lack of documentation the biggest problem right now&nbsp;&mdash; <span class="caps">MDN</span> needs to shift its focus from classic extensions to restartless extensions. I want to publish a few articles on how I solved the typical problems, this will hopefully be a good start.</p>