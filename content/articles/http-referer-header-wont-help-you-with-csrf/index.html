{
  "title": "HTTP Referer header won't help you with CSRF",
  "date": "2008-05-21 13:44:46",
  "description": "",
  "categories": [
    "security"
  ],
  "slug": "http-referer-header-wont-help-you-with-csrf"
}

	<p>It seems to be obvious but apparently this idea still isn&#8217;t common knowledge&nbsp;&mdash; <span class="caps">HTTP</span> Referer header is unreliable, and it is especially unsuited for any security measures. The Referer header isn&#8217;t always present because of users going to a page directly (via bookmark and similar), using an &#8220;unusual&#8221; browser (most commonly download helper applications), using filtering firewalls (privacy protection) etc. The Referer header might be incorrect because of the same filtering firewalls (some prefer to advertise rather than remove the header entirely), special browser extensions to manipulate the Referer header etc.</p>

	<p>And in addition to that we also have the fact that referring websites can remove the Referer header with tricks like <span class="caps">META</span> refresh. With slightly more advanced tricks these websites can even send <span class="caps">POST</span> requests without a Referer header. Sending a fake Referer header is harder but in the past it was possible via XMLHttpRequest or Flash&nbsp;&mdash; and it still might be possible somehow.</p>

	<p>So, what does this all have to do with <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">Cross-Site Request Forgery</a> (<span class="caps">CSRF</span>)? With <span class="caps">CSRF</span> a malicious website can abuse the fact that its visitor has some special kind of access to another website (usually because he is logged in on that site). E.g. the malicious site can embed an <span class="caps">HTML</span> tag like this one:</p>

<pre><code>&lt;img src=&quot;http://good.site.example/?action=doSomething&quot;&gt;
</code></pre>

	<p>This makes the browser of the site visitor send a request to good.site.example&nbsp;&mdash; with user&#8217;s IP address and with user&#8217;s authentication cookies. If good.site.example accepts the request because it comes from an authenticated user, the malicious site might do anything the user himself can do, like posting spam in a forum or changing user&#8217;s password.</p>

	<p>Now to the solutions. A well-designed site should only accept <span class="caps">GET</span> requests to show some information, any actions that actually change something should always be sent as <span class="caps">POST</span> requests. This is a good first step, and will raise the bar for <span class="caps">CSRF</span>&nbsp;&mdash; it will no longer be possible to run a <span class="caps">CSRF</span> attack against your site by simply posting an image to a forum. However, if the attacker has full control over the <span class="caps">HTML</span> code of the attacking web page, he can still create a hidden form and submit it automatically, so <span class="caps">CSRF</span> isn&#8217;t limited to <span class="caps">GET</span> requests.</p>

	<p>And here comes the wrong solution. As a cheap way to detect that the request actually originated on your site, some people use the Referer header. And a missing Referer header is also accepted because it would break too many users. This has the obvious problem that malicious sites can also send requests with an empty Referer header, as I mentioned above. Thankfully, addons.mozilla.org closed this vulnerability within days after I demonstrated how it can be exploited. The new solution is to send user&#8217;s session ID with all <span class="caps">POST</span> requests, if the received session ID doesn&#8217;t match the one in user&#8217;s cookie the request is ignored. Since the malicious site cannot know the session ID (by definition, otherwise it wouldn&#8217;t need the user to perform the request), this effectively prevents <span class="caps">CSRF</span>.</p>

	<p>A more interesting case is the Fritz!Box router by <a href="http://www.avm.de/"><span class="caps">AVM</span></a>. After <a href="http://www.gnucitizen.org/blog/bt-home-flub-pwnin-the-bt-home-hub/"><span class="caps">GNUCITIZEN</span> reported on <span class="caps">CSRF</span> vulnerabilities in router web interfaces</a>, I decided to have a look at my own Fritz!Box. After the initial impression that it didn&#8217;t have a <span class="caps">CSRF</span> protection, I discovered that the <span class="caps">CSRF</span> protection was there but of a very peculiar kind. While being based on Referer header, it didn&#8217;t simply compare the host name part of it with the valid values (&#8220;fritz.box&#8221; or the IP address of the router), it did a <span class="caps">DNS</span> request to resolve it. If the <span class="caps">DNS</span> request failed or the host name resolved to a local address, the request was accepted. No wonder that trying to do <span class="caps">CSRF</span> from localhost worked.</p>

	<p>I reported that issue to <span class="caps">AVM</span> in January, sent exploit code (that would make the router dial a paid phone number) as well as a description of <a href="http://en.wikipedia.org/wiki/DNS_rebinding"><span class="caps">DNS</span> rebinding</a> as an additional (though more complicated) way to fool their protection. The new firmware came out half a month ago. What changed? There is now a recommendation in the user interface to set a configuration password (it doesn&#8217;t <strong>require</strong> you to set the password however meaning that the majority of users will stay vulnerable). Also, automatic dialing is now disabled unless you set a configuration password (great, that leaves only a few hundred other options in the user interface that can still be tweaked via <span class="caps">CSRF</span>). Oh, and the router can no longer be accessed as &#8220;http://fritz.box/&#8221;, you have to know the IP address&nbsp;&mdash; not sure whether this change is related but most people will use the default IP address anyway. To say that I am disappointed is an understatement.</p>

	<p>There are already <a href="http://www.heise-online.co.uk/security/news/102352">reports of first <span class="caps">CSRF</span> attacks against <span class="caps">DSL</span> routers</a>. So, if you own a Fritz!Box and don&#8217;t want to become the next victim, I recommend you set a configuration password. And moving the router away from a guessable IP address should be a good idea as well. Oh, and feel free to contact info@avm.de to complain about their routers still being vulnerable with the default configuration.</p>

	<p><strong>Update</strong>: Apparently, you can still access the router as &#8220;http://fritz.box/&#8221;, it only didn&#8217;t work for me because of <span class="caps">VPN</span>. So moving the router to a different IP address is pointless unless you also block the addresses &#8220;http://fritz.box/&#8221; and &#8220;http://fritz.fonwlan.box/&#8221; (e.g. with Adblock Plus or the hosts file).</p>